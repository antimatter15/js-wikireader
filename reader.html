<!doctype html>
<html>
<head>
<meta charset="utf-8">

<style>
body {
  font-family: sans-serif;
  font-size: 13px;
  overflow-y: scroll;
  color: #111111;
  background-color: #fefdfc;
}

pre {
  word-wrap: break-word;
}

#results li {
  list-style-type: none;
}

#results {
  padding: 0;
  margin: 0;
  padding-left: 10px;
}

#results ol {
  padding-left: 10px;
}

#results * {
  word-wrap: break-word;
}

a:hover {
    text-decoration: underline;
}
a:visited {
    color: #0b0080;
}
a {
  text-decoration: none;
  color: #0645AD;
  background: none;
}

a:active {
  color: #FAA700;
}

#viewsrc {
  font-family: monospace;
}
a.new {
  color: #C20;
}
</style>
<title>carrot</title>

</head>
<body>
<div style="padding: 10px; float: right; visibility:hidden" id="searchbox">
  <input type="text" id="search" style="width: 200px; border: 1px solid gray;margin-bottom: 0" placeholder="Search here">
  <div style="font-size: small; border: 1px solid gray; width: 200px; margin-top: 0px; padding-top: 9px; padding-bottom: 10px; border-top: none; background-color: #F3F3F3;">
    <ol id="results">
      Start searching
    </ol>
  </div>
</div>

<div  style="padding:10px; float: right">

<select id="dumpselect">
  <option value="_add">Add More</option>
</select>
<div id="toolbar" style="visibility:hidden; display:inline">
  <button onclick="loadRandomPage()">Random</button>
</div>
</div>

<article id="page" style="padding: 10px"></article>

<div id="setup" style="display:none; padding: 10px">
<img src="bunny.jpg" width="300" style="float:left;padding-right: 25px">
<input type="file" id="fileselect" style="position:absolute;top: 219px;left: 33px;background-color: orange;border-radius: 14px;padding: 5px;">
<div>
<h1>Feed the bunny!</h1>
<p>
or else...
Well, I'm not sure, but I guess she will attack you.
</p>
<p>
Before she eats your brains, please note that this is a very special type of bunny. This bunny feeds on knowledge, so you must feed her a specially formatted wikipedia dump file so she can find her way around the scary offline world.
</p>
</div>
</div>
<footer>
<hr>
<div id="debug">
<div style="float: right">
<a href="javascript:toggleDebug()" id="debugMode">Debug On</a>
</div>

<div id="viewsrc"></div>
</debug>
<div style="font-size: x-small">
		  written by <a href="http://twitter.com/antimatter15">@antimatter15</a> (please follow me on twitter). email comments and concerns to antimatter15@gmail.com.
		</div>
</footer>

<script src="slugfy.js"></script>
<script src="render.js"></script>
<script src="damlev.js"></script>
<script src="LZMA_simple.js"></script>
<script src="binsearch.js"></script>
<script>
debug = localStorage.debug == 'true';

function toggleDebug(){
  debug = !debug;
  updateDebug();
}

function updateDebug(){
  var vs = document.getElementById('viewsrc');
  vs.style.display = debug ? '' : 'none';
  document.getElementById('debugMode').innerHTML = debug ? 'Debug Off': 'Debug On';
  localStorage.debug = debug + '';
}

updateDebug();
//*
document.body.onclick = function(e){
  if(e.button == 0 && e.target.tagName.toLowerCase() == 'a'){
    if(e.target.href.replace(/\?.*$/,'') == location.href.replace(/\?.*$/,'')){
      //console.log('click', +new Date);
      e.preventDefault();
      //history.replaceState({scrollX: scrollX, scrollY: scrollY}, '', location.href);
      
      history.pushState({}, '', e.target.href);
      loadArticle(unescape(location.search.substr(1)))
    }
  }
}//*/

var pagescrolls = {};

var fs = null;
document.getElementById('dumpselect').onchange = updateSelection;

function updateSelection(){
  var select = document.getElementById('dumpselect');
  if(select.value == '_add'){
    document.getElementById("setup").style.display = '';
    document.getElementById("debug").style.display = 'none';
    document.getElementById("page").style.display = 'none';
    document.getElementById("searchbox").style.visibility = 'hidden';
    document.getElementById("toolbar").style.visibility = 'hidden';
  }else{
    localStorage._current = select.value;
    loadDump(select.value);
    document.getElementById("debug").style.display = '';
    document.getElementById("page").style.display = '';
    document.getElementById("searchbox").style.visibility = '';
    document.getElementById("toolbar").style.visibility = '';
    document.getElementById("setup").style.display = 'none'
  }
}
document.getElementById('fileselect').onchange = function(e){
  var file = this.files[0];
  console.log(file);
  if(!file) return;
  var fr = new FileReader();
  fr.onload = function(){
    var metasize = parseInt(fr.result.substr(0,20), 10);
    var mr = new FileReader();
    mr.onload = function(){
      var meta = JSON.parse(mr.result);
      localStorage[meta.code] = meta.name;
      var name = meta.code;
      fs.root.getFile(name+".dump", {create: true, exclusive: false}, function(fileEntry) {
        fileEntry.createWriter(function(fileWriter) {
          fileWriter.write(file);
          console.log('writing dump')
        }, errorHandler);
      }, errorHandler);
    }
    mr.readAsText(file.slice(40, metasize));
  }
  fr.readAsText(file.slice(0,40))
}

var lastart = 0, lastquery = '';
document.getElementById('search').onkeyup = function(){
  if(this.value.length == 0 || lastquery == this.value) return;
  lastquery = this.value;
  runSearch(this.value, function(results, levdict){
    displayResults(results, levdict);
    var name = results[0][0];
    loadArticle(name) //todo: optimize for redirects.
    
    if(+new Date - lastart > 3000) history.pushState({}, '', '?'+name);
    else history.replaceState({}, '', '?'+name);
    
    lastart = +new Date;
  })
}


function scoreResult(result, query){
  return damlev(result.substr(0, query.length), query) * 0.3 + damlev(result.substr(0, query.length).toLowerCase(), query.toLowerCase()) * 0.2 + Math.abs(query.length - result.length) * 0.1
}

function displayResults(results, levdict){
  var art = document.getElementById('results');
  art.innerHTML = '';
  var redict = {};
  results.slice(0,20).forEach(function(item){
    var li = document.createElement('li');
    var d = '';
    if(window.debug){
      d = ' ('+ levdict[item[0]].toFixed(1)+')'
    }
    if(item[2]){
      if(!redict[item[1]]){
        li.innerHTML = '<a href="?'+encodeURIComponent(item[1])+'">'+item[1]+"<"+"/a>";
        var ol = document.createElement('ol');
        li.appendChild(ol)
        redict[item[1]] = ol;
        art.appendChild(li);
      }
      if(redict[item[1]].childNodes.length < 2){
        redict[item[1]].innerHTML += "<li>"+item[0]+d+"<"+"/li>";
      }
    }else if(!redict[item[0]]){
      li.innerHTML = '<a href="?'+encodeURIComponent(item[0])+'">'+item[0]+d+"<"+"/a>";
      art.appendChild(li);
    }
  })
}

function runSearch(query, callback, exactness){
  exactness = exactness || 10000;
  binsearch(0, index.size, slugfy(query), function(size, length, slug){
    var fr = new FileReader();
    fr.onload = function(){
      var results = fr.result.split('\n').slice(1, -1).map(function(item){
        if(item.indexOf('>') != -1) return item.split('>').concat([true])
        else return item.split(';');
      })
      var levdict = {};
      //console.log(results.map(function(x){return x[0]}));
      results.forEach(function(item){
        levdict[item[0]] = scoreResult(item[0], query)
      });
      results = results.sort(function(a,b){
        return levdict[a[0]] - levdict[b[0]];
      })
      callback(results, levdict);
    }
    fr.readAsText(index.slice(size - 250, exactness + 250), 'utf-8')
  }, exactness + 500)
}


function randomPage(callback){
  var fr = new FileReader();
  fr.onload = function(){
    var results = fr.result.split('\n').slice(1, -1).map(function(item){
      if(item.indexOf('>') != -1) return item.split('>')[1]
      else return item.split(';')[0];
    })
    callback(results[0]);
  }
  fr.readAsText(index.slice(Math.floor(index.size * Math.random()), 1000), 'utf-8')
}


function loadRandomPage(){
  randomPage(function(e){
    loadArticle(e)
    //location.hash = '#'+e;
    history.pushState({}, '', '?'+e)
  })
}


var index, dump;


function loadDump(code){
  console.log('loading dump',code);
  fs.root.getFile(code+'.dump', {create:false}, function(e){
    e.file(function(file){
      var fr = new FileReader();
      fr.onload = function(){
        var metasize = parseInt(fr.result.substr(0,20), 10);
        var indexsize = parseInt(fr.result.substr(20,20), 10);
        var mr = new FileReader();
        mr.onload = function(){
          var meta = JSON.parse(mr.result);
          localStorage[meta.code] = meta.name; //hash to have prettier names.
          
          //loadArticle(location.search.substr(1))
        }
        mr.readAsText(file.slice(40, metasize));
        index = file.slice(40 + metasize, indexsize);
        dump = file.slice(40 + metasize + indexsize, file.size);
        console.log('loaded index and dump')
      }
      fr.readAsText(file.slice(0,40))
    })
  }, function(){
  
  })
}
var linkcache = {};
function checkLink(link){
  var title = unescape(link.href.replace(/^.*\?/,'').replace(/\#.*$/,''));
  if(title in linkcache){
    if(linkcache[title]) link.className += ' new';
  }else{
    setTimeout(function(){
      runSearch(title, function(results, levdict){
        linkcache[title] = levdict[results[0][0]] > 1;
        //console.log(title, results, levdict);
        if(levdict[results[0][0]] > 1){
          link.className += ' new'
        }
      }, 250)
    },0);
  }
}
function checkLinks(){
  for(var i = 0, links = document.getElementById('page').getElementsByTagName('a'); i < links.length; i++){
    checkLink(links[i]);
  }
}

//*
setInterval(function(){
  pagescrolls[unescape(location.search.substr(1))] = [scrollX, scrollY];
},100);
//*/
onpopstate = function(e){
  if(location.search.length <= 1){
    document.getElementById('page').innerHTML = '<img src="xkcd.png">';
  }else{
    state = pagescrolls[unescape(location.search.substr(1))] || [];
    loadURL();
  }
}

function loadURL(){
  if(window.index){
    loadArticle(unescape(location.search.substr(1)))
  }else setTimeout(loadURL, 0);
}

function loadArticle(title){
  runSearch(title, function(results){
    if(results[0][2]) return loadArticle(results[0][1]); //handle redirects.
    var title = results[0][0],
        blockpos = parseInt(results[0][1],10);
    //console.log('finished search', +new Date);
    decodeArticle(title, blockpos, 60000);
  }, 1000)
}


var state = [];
function decodeArticle(title, blockpos, blocksize){
  var fr = new FileReader();
  fr.onload = function(){
    var blockarr = fr.result.split('').map(function(x){
      return x.charCodeAt(0)
    });
    var block = LZMA.decompress(blockarr);
    var p = document.getElementById('page');
    if(block == false){
      p.innerHTML = 'Error in decompressing LZMA archive. Block index: '+blockpos+' Title: '+title;
      //this gives the size of the decoded thing if it doesnt fit.
      //however, we want the compressed size. not the final size.
      //but it doesnt really matter
      var truesize = blockarr.slice(5, 5 + 8).map(function(num, pos){
        return num * Math.pow(256, pos)
      }).reduce(function(a,b){
        return a+b
      });
      
      if(blocksize < 0.8 * truesize){
        console.log('trying again');
        return decodeArticle(title, blockpos, blocksize);
      }
      
      return
    };
    var artpos = block.indexOf('='+title+'=\n\n\n\n');
    var article = block.substr(artpos);
    var match = article.substr(4).match(/=[^\n=]*?=\n\n\n\n/);
    if(match) article = article.substr(0, match.index + 4);
    article = article.replace(/\n\n\n\n/, '\n\n')
    //console.log(article);
    
    p.innerHTML = '';
    
    article = article.replace(/\{\{([^\n\|]+)\|([^\n\|]+)}\}/g,' $1 $2 ');
    //article = article.replace(/\=+Pronunciation\=+[^\=]+(=+)/gi, '$1')
    article = article.replace(/\{\{t.?\|(\w\w)\|([^\|]+?)(\|[^\}]+?)?\}\}/g, '  $2  ')
    article = article.replace(/\{\{([\w ]+?)\}\}/g, '  <tt>$1</tt>  ')
    p.innerHTML = wikiParse(article);
    
    scrollTo(state[0]||0,state[1]||0)
    state = {};
    
    document.title = title;

    document.getElementById('viewsrc').innerText = article;
    setTimeout(function(){
      if(document.title == title){
        checkLinks();
      }
    },1000)
    
    //console.log(+new Date);
  }
  fr.readAsBinaryString(dump.slice(blockpos, blocksize)) //todo: handle fringe cases where results are huge
  //todo: get this window from ratio + window size from metadata
}


function onInitFs(hfs) {
  fs = hfs; //set an evil global
  console.log('Opened file system: ' + fs.name);
  findDumps();
}


function findDumps(){
  var dirReader = fs.root.createReader();
  var entries = [];
  var readEntries = function(){
    dirReader.readEntries(function(results){
      if(!results.length){
        var select = document.getElementById('dumpselect');
        while(select.options.length > 1) select.removeChild(select.options[0]);
        var addmore = select.options[0];
        entries.forEach(function(item){
          if(/\.dump$/.test(item.name)){
            var code = item.name.replace('.dump','');
            var opt = document.createElement('option');
            opt.innerHTML = localStorage[code] || code;
            if(code == localStorage._current){
              opt.setAttribute('selected','selected');
            }
            opt.value = code;
            select.insertBefore(opt, addmore);
          }
        });
        updateSelection();
      }else{
        entries = entries.concat([].slice.call(results, 0));
        readEntries();
      }
    }, errorHandler);
  }
  readEntries();
}

function errorHandler(){
  console.log('Error');
}
window.requestFileSystem(window.PERSISTENT, 10*1024*1024*1024 /*GB*/, onInitFs, errorHandler);


</script>
</body>
</html>
